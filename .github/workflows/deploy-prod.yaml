name: ğŸ­ Deploy a PRODUCCIÃ“N

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Â¿Confirmas el deploy a PRODUCCIÃ“N? (escribe: SI)'
        required: true
        default: 'NO'

jobs:
  deploy-production:
    name: Desplegar a ProducciÃ³n
    runs-on: mi-runners
    if: github.event.inputs.confirm == 'SI'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Instalar kubectl
      run: |
        echo "ğŸ“¥ Instalando kubectl v1.30.0..."
        curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client

    - name: Mostrar info del cluster y contexto
      run: |
        echo "ğŸ” KUBECONFIG (path): ${KUBECONFIG:-$HOME/.kube/config}"
        echo "ğŸ” Contextos disponibles:"
        kubectl config get-contexts || true
        echo "ğŸ” Contexto actual:"
        kubectl config current-context || true
        echo "ğŸ” Versiones (cliente/servidor si accesible):"
        kubectl version --short || true
        echo "ğŸ” Cluster info:"
        kubectl cluster-info 2>&1 || echo "kubectl no tiene acceso al cluster o KUBECONFIG no estÃ¡ configurado"
        echo "ğŸ” Nodos (si estÃ¡n disponibles):"
        kubectl get nodes -o wide 2>&1 || echo "No hay nodos visibles o no hay permisos"
        echo "ğŸ” Namespaces visibles:"
        kubectl get ns || true
        echo "ğŸ” Pods actuales en todos los namespaces:"
        kubectl get pods -A || true

    - name: Crear namespace si no existe
      run: |
        kubectl get ns prod || kubectl create ns prod
      
    - name: ConfirmaciÃ³n de producciÃ³n
      run: |
        echo "ğŸš¨ DESPLEGANDO A PRODUCCIÃ“N ğŸš¨"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        
    - name: Backup actual
      run: |
        echo "ğŸ’¾ Creando backup..."
        kubectl get deployment mi-app -n prod -o yaml > backup-prod.yaml 2>/dev/null || echo "No hay deployment previo"
        
    - name: Desplegar a producciÃ³n
      run: |
        echo "ğŸ­ Desplegando a PRODUCCIÃ“N..."
        kubectl apply -f k8s/prod/app-prod.yaml -n prod
        
    - name: Esperar deployment
      run: |
        kubectl rollout status deployment/mi-app -n prod --timeout=600s
        
    - name: Verificar resultado
      run: |
        echo "âœ… Estado final en PRODUCCIÃ“N:"
        kubectl get pods -n prod -o wide
        kubectl get svc -n prod
        echo "ğŸŒ Accesible en: http://localhost:30003"
        
    - name: Test de producciÃ³n
      run: |
        echo "ğŸ§ª Test final de producciÃ³n..."
        kubectl run test-prod --image=curlimages/curl --rm -i --restart=Never -n prod -- \
          curl -s http://mi-app-service.prod.svc.cluster.local || echo "Test completado"
        
    - name: Rollback si algo falla
      if: failure()
      run: |
        echo "ğŸ”™ Â¡Algo fallÃ³! Haciendo rollback..."
        if [ -f backup-prod.yaml ]; then
          kubectl apply -f backup-prod.yaml
          echo "âœ… Rollback desde backup completado"
        else
          kubectl rollout undo deployment/mi-app -n prod
          echo "âœ… Rollback automÃ¡tico completado"
        fi
